================================================================================
PREREQUISITES
================================================================================

1. SSH into the EC2 instance:
   ssh -i ~/.ssh/nexeo.pem ubuntu@3.134.46.103

2. Ensure you're in the correct directory:
   cd ~/dg-compat-lab-prev


================================================================================
STEP 1: Start Qdrant (Vector Database)
================================================================================

Start Qdrant in a screen session:

screen -dmS qdrant bash -c '
  cd ~/dg-compat-lab
  podman run -d \
    --name qdrant \
    -p 6333:6333 \
    -p 6334:6334 \
    -v ~/dg-compat-lab/qdrant_storage:/qdrant/storage \
    qdrant/qdrant:latest
  echo "Qdrant started"
  exec bash
'

Verify Qdrant is running:

sleep 5
podman ps | grep qdrant

Check collections:

curl -s http://localhost:6333/collections/menu | jq '.result.points_count'
curl -s http://localhost:6333/collections/modifiers | jq '.result.points_count'

Expected: 615 menu items, 154094 modifiers


================================================================================
STEP 2: Start Rust Backend (Menu Query Service)
================================================================================

Start Rust backend in a screen session:

screen -dmS rust-backend bash -c '
  cd ~/dg-compat-lab-prev/rust-code
  
  export DEEPGRAM_API_KEY=5f79e12e8c744cdfc10b465f8b3cf40dff0d9c49
  export QU_BASE_URL=https://gateway-api.qubeyond.com/api/v4
  export CLIENT_ID=deepgramjitb405
  export QU_SECRET="6Nffn0*5QshgFVT]5>6Y"
  export LOCATION_ID=4776
  export QDRANT_URL=http://localhost:6334
  export USE_VECTOR=1
  export SKIP_INDEX=0
  export LIBTORCH=/opt/libtorch
  export LD_LIBRARY_PATH=/opt/libtorch/lib:$LD_LIBRARY_PATH
  
  echo "Starting Rust backend..."
  ./target/release/nexeo-sts
'

Wait for startup (takes about 20 seconds):

echo "Waiting 20 seconds for Rust backend startup..."
sleep 20

Verify Rust backend is running:

curl -X POST "http://localhost:4000/query/items" \
  -H "Content-Type: application/json" \
  -d '{"query": "burger", "limit": 1}' | jq '.items[0].title'

Expected: Should return a burger item name


================================================================================
STEP 3: Refresh Prices from Qu API
================================================================================

Now that the menu is loaded in Rust backend, refresh prices:

cd ~/dg-compat-lab
source myenv/bin/activate
python3 get_full_menu_with_prices.py

Wait for completion (takes 10-15 seconds):

Expected output:
  - JWT authentication success
  - Location context fetched
  - Menu download (~137MB)
  - "Extracted 86115 items with prices"
  - "Saved price map to: qu_prices_complete.json"

Verify prices were updated:

cat qu_prices_complete.json | grep extracted_at

Expected: Shows current timestamp



================================================================================
STEP 4: Start Python Web Service
================================================================================

Restart the Python service:

sudo systemctl restart jitb-web

Wait and check status:

sleep 5
sudo systemctl status jitb-web --no-pager | head -15

Verify website is accessible:

curl -s https://jitb.deepgram.com/ | grep -o "<title>.*</title>"

Expected: <title>Jack in the Box Voice Agent</title>


================================================================================
STEP 5: Verify All Services
================================================================================

Run these commands to check everything:

echo "Service Status Check:"
echo ""

echo "1. Qdrant:"
podman ps | grep qdrant && echo "   Running" || echo "   Not running"

echo "2. Rust Backend:"
curl -s -X POST "http://localhost:4000/query/items" \
  -H "Content-Type: application/json" \
  -d '{"query": "test", "limit": 1}' > /dev/null 2>&1 && \
  echo "   Running on port 4000" || echo "   Not responding"

echo "3. Python Service:"
systemctl is-active jitb-web && echo "   Running" || echo "   Not running"

echo "4. Website:"
curl -s https://jitb.deepgram.com/ | grep -q "Jack in the Box" && \
  echo "   Accessible at https://jitb.deepgram.com/" || echo "   Not accessible"

echo ""
echo "All checks complete!"


================================================================================
MANAGING SCREEN SESSIONS
================================================================================

List all screen sessions:
  screen -ls

Attach to Qdrant screen (to see logs):
  screen -r qdrant

Attach to Rust backend screen (to see logs):
  screen -r rust-backend

Detach from screen (while inside):
  Press: Ctrl+A, then D

Kill a screen session:
  screen -S qdrant -X quit
  screen -S rust-backend -X quit


================================================================================
TROUBLESHOOTING
================================================================================

Problem: Qdrant not starting
Solution: 
  Check if port is in use:
    sudo lsof -i:6333
    sudo lsof -i:6334
  Stop existing container:
    podman stop qdrant && podman rm qdrant
  Then restart from Step 1

Problem: Rust backend returns empty query results
Solution:
  Check if Qdrant has data:
    curl -s http://localhost:6333/collections/menu | jq '.result.points_count'
  If 0, see FULL SYSTEM RESTART section
  Check logs:
    screen -r rust-backend

Problem: Rust backend not starting (port 4000 in use)
Solution:
  Kill existing process:
    sudo lsof -ti:4000 | xargs -r sudo kill -9
  Restart using Step 2

Problem: Python service failing
Solution:
  Check logs:
    sudo journalctl -u jitb-web -n 50
  Check if myenv exists:
    ls -la ~/dg-compat-lab/myenv/bin/python3
  Restart:
    sudo systemctl restart jitb-web

Problem: Website returns 502 Bad Gateway
Solution:
  Python service is down:
    sudo systemctl restart jitb-web


================================================================================
FULL SYSTEM RESTART (Re-index everything)
================================================================================

Only use if Qdrant collections are corrupted or missing data.

1. Stop all services:

podman stop qdrant && podman rm qdrant
sudo lsof -ti:4000 | xargs -r sudo kill -9
sudo systemctl stop jitb-web

2. Delete Qdrant storage:

rm -rf ~/dg-compat-lab/qdrant_storage/*

3. Start Qdrant:

podman run -d \
  --name qdrant \
  -p 6333:6333 \
  -p 6334:6334 \
  -v ~/dg-compat-lab/qdrant_storage:/qdrant/storage \
  qdrant/qdrant:latest

sleep 5

4. Start Rust backend:

cd ~/dg-compat-lab-prev/rust-code
export DEEPGRAM_API_KEY=5f79e12e8c744cdfc10b465f8b3cf40dff0d9c49
export QU_BASE_URL=https://gateway-api.qubeyond.com/api/v4
export CLIENT_ID=deepgramjitb405
export QU_SECRET="6Nffn0*5QshgFVT]5>6Y"
export LOCATION_ID=4776
export QDRANT_URL=http://localhost:6334
export USE_VECTOR=1
export SKIP_INDEX=0
export LIBTORCH=/opt/libtorch
export LD_LIBRARY_PATH=/opt/libtorch/lib:$LD_LIBRARY_PATH

nohup ./target/release/nexeo-sts > ~/rust-reindex.log 2>&1 &

5. Wait for indexing (takes 2-3 minutes):

echo "Waiting 180 seconds for full indexing..."
sleep 180

6. Start Python service:

sudo systemctl start jitb-web

7. Verify:

curl -X POST "http://localhost:4000/query/items" \
  -H "Content-Type: application/json" \
  -d '{"query": "burger", "limit": 1}' | jq '.'


================================================================================
QUICK REFERENCE - Rust Backend Environment Variables
================================================================================

DEEPGRAM_API_KEY=5f79e12e8c744cdfc10b465f8b3cf40dff0d9c49
QU_BASE_URL=https://gateway-api.qubeyond.com/api/v4
CLIENT_ID=deepgramjitb405
QU_SECRET="6Nffn0*5QshgFVT]5>6Y"
LOCATION_ID=4776
QDRANT_URL=http://localhost:6334
USE_VECTOR=1
SKIP_INDEX=0
LIBTORCH=/opt/libtorch
LD_LIBRARY_PATH=/opt/libtorch/lib:$LD_LIBRARY_PATH


================================================================================
LOGS LOCATIONS
================================================================================

Qdrant logs:
  podman logs qdrant

Rust Backend logs:
  screen -r rust-backend
  Or check files: ~/rust-*.log

Python Service logs:
  sudo journalctl -u jitb-web -f
  ~/dg-compat-lab/jitb-web-full.log


================================================================================
MAINTENANCE COMMANDS
================================================================================

Restart Python service only:
  sudo systemctl restart jitb-web

Restart Rust backend only:
  screen -S rust-backend -X quit
  Then run Step 2 again

View real-time Python logs:
  tail -f ~/dg-compat-lab/jitb-web-full.log

Check system resources:
  htop

Check disk space:
  df -h



